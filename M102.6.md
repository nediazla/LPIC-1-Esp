# 6. Seguridad

## 6.1 Realización de tareas de gestión de seguridad del sistema

### Actualización del sistema

Actualizar repositorios:
```
apt update
```

Actualizar paquetes:
```
apt upgrade
apt full-upgrade
```

Eliminar paquetes innecesarios:
```
apt autoremove
```

### Gestión de usuarios y permisos

Ver permisos:
```
ls -l archivo
stat archivo
```

Cambiar permisos:
```
chmod 700 archivo
chmod 644 archivo
```

Cambiar propietario y grupo:
```
chown usuario:grupo archivo
```

Bloquear usuario:
```
passwd -l usuario
```

Desbloquear usuario:
```
passwd -u usuario
```

Ver si un usuario está bloqueado:
```
passwd -S usuario
```

Expiración de contraseñas:
```
chage -l usuario
chage -E 2025-12-31 usuario
```

### Control de acceso básico

Archivos importantes:
```
/etc/passwd
/etc/shadow
/etc/group
/etc/sudoers
```

Editar sudoers:
```
visudo
```

Agregar usuario a sudo:
```
usermod -aG sudo usuario
```

---

## 6.2 Configuración de la seguridad de un host

### Firewall con UFW (Ubuntu)

Instalar (si no está):
```
apt install ufw
```

Activar:
```
ufw enable
```

Ver estado:
```
ufw status
```

Permitir puertos:
```
ufw allow 22
ufw allow 80/tcp
ufw allow 443/tcp
```

Denegar:
```
ufw deny 23
```

Eliminar reglas:
```
ufw delete allow 22
```

Resetear UFW:
```
ufw reset
```

### Firewall con iptables (bajo nivel)

Listar reglas:
```
iptables -L -n -v
```

Permitir SSH:
```
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

Bloquear todo:
```
iptables -P INPUT DROP
```

Guardar reglas:
```
iptables-save > reglas.iptables
```

Aplicar reglas:
```
iptables-restore < reglas.iptables
```

### Deshabilitar servicios innecesarios

Ver servicios:
```
systemctl list-unit-files --type=service
```

Desactivar:
```
systemctl disable servicio
systemctl stop servicio
```

### Permisos y atributos avanzados

Archivos inmutables:
```
chattr +i archivo
```

Modo solo append:
```
chattr +a archivo
```

Ver atributos:
```
lsattr archivo
```

### Seguridad de SSH

Editar configuración:
```
/etc/ssh/sshd_config
```

Opciones recomendadas:
```
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
```

Reiniciar SSH:
```
systemctl restart ssh
```

### Fail2ban (protección ante fuerza bruta)
```
apt install fail2ban
systemctl enable --now fail2ban
```

Archivo principal:
/etc/fail2ban/jail.conf

Logs:
```
/var/log/fail2ban.log
```

---

## 6.3 Protección de datos mediante encriptación

### Encriptación de archivos con GPG

Generar llave:
```
gpg --full-generate-key
```

Listar llaves:
```
gpg --list-keys
```

Encriptar archivo:
```
gpg -c archivo.txt
```

Desencriptar:
```
gpg archivo.txt.gpg
```

Encriptar para un usuario:
```
gpg -e -r "Nombre" archivo.txt
```

### Hashing (no encriptación)

Generar hash:
```
sha256sum archivo.iso
md5sum archivo.txt
```

Comparar hash descargado:
```
sha256sum archivo.iso
```

### Encriptación de particiones con LUKS

Instalar herramientas:
```
apt install cryptsetup
```

Crear partición encriptada:
```
cryptsetup luksFormat /dev/sdb1
```

Abrir volumen:
```
cryptsetup luksOpen /dev/sdb1 volumen1
```

Crear sistema de archivos:
```
mkfs.ext4 /dev/mapper/volumen1
```

Montar:
```
mount /dev/mapper/volumen1 /mnt
```

Cerrar volumen:
```
cryptsetup luksClose volumen1
```

### Backups cifrados con tar + gpg

Crear backup cifrado:
```
tar -czf - /etc | gpg -c > backup.tgz.gpg
```

Restaurar:
```
gpg -d backup.tgz.gpg | tar -xzf -
```

### Transferencias seguras

scp:
```
scp archivo usuario@host:/ruta
```

rsync con SSH:
```
rsync -avz -e ssh /src usuario@host:/dst
```
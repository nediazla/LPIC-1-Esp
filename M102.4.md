# 4. Servicios esenciales del sistema

## 4.1 Mantenimiento de la hora del sistema

Ver hora y estado de sincronización:
```
timedatectl
```

Cambiar zona horaria:
```
timedatectl list-timezones
timedatectl set-timezone Europe/Madrid
```

Ver sincronización NTP:
```
timedatectl show-timesync --all
```

Activar o desactivar NTP:
```
timedatectl set-ntp true
timedatectl set-ntp false
```

Servicio del sincronizador (systemd-timesyncd):
```
systemctl status systemd-timesyncd
systemctl restart systemd-timesyncd
```

Editar configuración en:
```
/etc/systemd/timesyncd.conf
```

Ejemplo:
```
[Time]
NTP=0.es.pool.ntp.org 1.es.pool.ntp.org
FallbackNTP=pool.ntp.org
```

Comprobar deriva y ajustes:
```
ntpq -p
```

(Disponible si se instala `ntp`.)

---

## 4.2 Logs del sistema

Linux usa **journald** (systemd) y archivos en `/var/log`.

### Ver logs con journald
```
journalctl
journalctl -b        # último arranque
journalctl -u ssh    # servicio específico
journalctl -p err    # solo errores
journalctl -f        # seguimiento (como tail -f)
```

Limitar tamaño del journal:
```
journalctl --vacuum-size=200M
```

Vaciar logs antiguos:
```
journalctl --vacuum-time=10d
```

### Archivos tradicionales de logs
```
/var/log/syslog
/var/log/auth.log
/var/log/dmesg
/var/log/kern.log
/var/log/apt/
```

Ver:
```
less /var/log/syslog
tail -f /var/log/auth.log
```

### Logrotate
Maneja rotación automática de logs.

Config global:
```
/etc/logrotate.conf
```

Config por aplicación:
```
/etc/logrotate.d/
```

Ejecutar rotación manual:
```
logrotate -f /etc/logrotate.conf
```

---

## 4.3 Fundamentos del agente de transferencia de correo (MTA)

Un **MTA** (Mail Transfer Agent) envía y recibe correos en sistemas Unix.

Ejemplos:
- postfix (el más común en Ubuntu)
- sendmail
- exim4

### Ver si postfix está instalado
```
dpkg -l | grep postfix
```

Instalar postfix:
```
apt install postfix
```

Modo de configuración básico:
```
dpkg-reconfigure postfix
```

### Archivos principales de postfix
```
/etc/postfix/main.cf
/etc/postfix/master.cf
```

Ver estado del servicio:
```
systemctl status postfix
systemctl restart postfix
systemctl enable postfix
```

### Enviar correo desde terminal
```
echo "Mensaje" | mail -s "Asunto" usuario@dominio
```

Ver cola de correo:
```
postqueue -p
```

Vaciar cola:
```
postsuper -d ALL
```

### Logs del MTA
```
/var/log/mail.log
/var/log/mail.err
```

Ver en tiempo real:
```
tail -f /var/log/mail.log
```

---

## 4.4 Impresión y gestión de impresoras

Linux utiliza **CUPS (Common UNIX Printing System)** como sistema de impresión.

### Instalar CUPS
```
apt install cups
```

Iniciar y habilitar:
```
systemctl start cups
systemctl enable cups
systemctl status cups
```

### Archivo de configuración principal
```
/etc/cups/cupsd.conf
```

Recargar configuración:
```
systemctl restart cups
```

### Gestión mediante interfaz web
Activar acceso:
CUPS se presenta en:
```
http://localhost:631
```

Se pueden añadir impresoras, drivers, colas, etc.

### Comandos básicos

Listar impresoras:
```
lpstat -p
lpstat -t
```

Imprimir archivo:
```
lp archivo.txt
lp -d impresora archivo.txt
```

Cancelar trabajos:
```
cancel job-id
```

Ver trabajos pendientes:
```
lpq
```

Eliminar una impresora:
```
lpadmin -x nombre_impresora
```

Agregar impresora (ejemplo):
```
lpadmin -p MiImpresora -E -v usb://HP/Modelo -m drv:///hp/hp-laserjet.ppd
```

### Logs de impresión
```
/var/log/cups/access_log
/var/log/cups/error_log
```

